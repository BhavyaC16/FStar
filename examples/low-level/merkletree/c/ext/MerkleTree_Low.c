/* This file was generated by KreMLin <https://github.com/FStarLang/kremlin>
 * KreMLin invocation: Kremlin.native -tmpdir ./ext -drop FStar,Prims,C,C.*,C.Loops.Spec.Loops,Spec.*,Lib.*,WasmSupport -drop Hacl.Cast,Hacl.UInt8,Hacl.UInt16,Hacl.UInt32,Hacl.UInt64,Hacl.UInt128 -drop Hacl.Spec.Endianness,Hacl.Endianness,Seq.Create -drop Hacl.Impl.SHA2_256.Lemmas,Hacl.Impl.SHA2_384.Lemmas,Hacl.Impl.SHA2_512.Lemmas -drop MerkleTree.High -I ../ ../MerkleTree.Low.fst lib/connect.c lib/Hacl_SHA2_256.c merkle_tree.c
 * F* version: d07b04c4
 * KreMLin version: b561bc14
 */

#include "MerkleTree_Low.h"

uint32_t MerkleTree_Low_hash_size = (uint32_t)32U;

uint32_t MerkleTree_Low_uint32_pow2(uint32_t sz)
{
  return (uint32_t)1U << sz;
}

bool MerkleTree_Low_uint32_is_pow2(uint32_t n1)
{
  bool b = n1 != (uint32_t)0U && (n1 & n1 - (uint32_t)1U) == (uint32_t)0U;
  return b;
}

uint32_t MerkleTree_Low_uint32_pow2_floor_(uint32_t n1)
{
  if (n1 == (uint32_t)1U)
    return (uint32_t)0U;
  else
    return (uint32_t)1U + MerkleTree_Low_uint32_pow2_floor_(n1 >> (uint32_t)1U);
}

uint32_t MerkleTree_Low_uint32_pow2_floor(uint32_t n1)
{
  return MerkleTree_Low_uint32_pow2_floor_(n1);
}

uint32_t MerkleTree_Low_uint32_num_of_ones(uint32_t n1)
{
  if (n1 == (uint32_t)0U)
    return (uint32_t)0U;
  else
  {
    uint32_t nones = n1 % (uint32_t)2U + MerkleTree_Low_uint32_num_of_ones(n1 / (uint32_t)2U);
    return nones;
  }
}

bool MerkleTree_Low_uu___is_MT(MerkleTree_Low_merkle_tree projectee)
{
  return true;
}

LowStar_Vector_vector_str__uint8_t_
MerkleTree_Low___proj__MT__item__values(MerkleTree_Low_merkle_tree projectee)
{
  LowStar_Vector_vector_str__uint8_t_ values = projectee.values;
  return values;
}

LowStar_Vector_vector_str__uint8_t_
MerkleTree_Low___proj__MT__item__iroots(MerkleTree_Low_merkle_tree projectee)
{
  LowStar_Vector_vector_str__uint8_t_ iroots = projectee.iroots;
  return iroots;
}

static LowStar_Vector_vector_str__uint8_t_
LowStar_Vector_create_rid__uint8_t_(uint32_t len, uint8_t *v1)
{
  KRML_CHECK_SIZE(sizeof(v1), len);
  uint8_t **buf = KRML_HOST_MALLOC(sizeof(v1) * len);
  for (uint32_t _i = 0U; _i < len; ++_i)
    buf[_i] = v1;
  return ((LowStar_Vector_vector_str__uint8_t_){ .sz = len, .cap = len, .vs = buf });
}

static void
LowStar_Vector_assign__uint8_t_(
  LowStar_Vector_vector_str__uint8_t_ vec,
  uint32_t i,
  uint8_t *v1
)
{
  uint8_t **vs = vec.vs;
  (vs + i)[0U] = v1;
}

static void
LowStar_BufVector_create___uint8_t(
  uint32_t blen,
  uint8_t ia,
  LowStar_Vector_vector_str__uint8_t_ bv,
  uint32_t cidx
)
{
  if (!(cidx == (uint32_t)0U))
  {
    LowStar_BufVector_new_region_();
    KRML_CHECK_SIZE(sizeof(ia), blen);
    uint8_t *buf = KRML_HOST_MALLOC(sizeof(ia) * blen);
    for (uint32_t _i = 0U; _i < blen; ++_i)
      buf[_i] = ia;
    LowStar_Vector_assign__uint8_t_(bv, cidx - (uint32_t)1U, buf);
    LowStar_BufVector_create___uint8_t(blen, ia, bv, cidx - (uint32_t)1U);
  }
}

static LowStar_Vector_vector_str__uint8_t_
LowStar_BufVector_create_rid__uint8_t(uint8_t ia, uint32_t blen, uint32_t len)
{
  LowStar_Vector_vector_str__uint8_t_ vec = LowStar_Vector_create_rid__uint8_t_(len, NULL);
  LowStar_BufVector_create___uint8_t(blen, ia, vec, len);
  return vec;
}

MerkleTree_Low_merkle_tree *MerkleTree_Low_create_merkle_tree()
{
  void *mt_region = (LowStar_BufVector_new_region_() , (void *)0U);
  LowStar_BufVector_new_region_();
  LowStar_Vector_vector_str__uint8_t_
  values =
    LowStar_BufVector_create_rid__uint8_t((uint8_t)0U,
      MerkleTree_Low_hash_size,
      (uint32_t)1U);
  LowStar_BufVector_new_region_();
  LowStar_Vector_vector_str__uint8_t_
  iroots =
    LowStar_BufVector_create_rid__uint8_t((uint8_t)0U,
      MerkleTree_Low_hash_size,
      (uint32_t)32U);
  KRML_CHECK_SIZE(sizeof (MerkleTree_Low_merkle_tree), (uint32_t)1U);
  MerkleTree_Low_merkle_tree *buf = KRML_HOST_MALLOC(sizeof (MerkleTree_Low_merkle_tree));
  buf[0U] = ((MerkleTree_Low_merkle_tree){ .values = values, .iroots = iroots });
  return buf;
}

static LowStar_Vector_vector_str__uint8_t_
LowStar_Vector_insert__uint8_t_(LowStar_Vector_vector_str__uint8_t_ vec, uint8_t *v1)
{
  uint32_t sz = vec.sz;
  uint32_t sz0 = sz;
  uint32_t cap = vec.cap;
  uint32_t cap0 = cap;
  uint8_t **vs = vec.vs;
  uint8_t **vs0 = vs;
  if (sz0 == cap0)
  {
    uint32_t ncap = LowStar_Vector_new_capacity(cap0);
    KRML_CHECK_SIZE(sizeof(v1), ncap);
    uint8_t **nvs = KRML_HOST_MALLOC(sizeof(v1) * ncap);
    for (uint32_t _i = 0U; _i < ncap; ++_i)
      nvs[_i] = v1;
    memcpy(nvs, vs0, sz0 * sizeof vs0[0U]);
    nvs[sz0] = v1;
    KRML_HOST_FREE(vs0);
    return
      ((LowStar_Vector_vector_str__uint8_t_){ .sz = sz0 + (uint32_t)1U, .cap = ncap, .vs = nvs });
  }
  else
  {
    vs0[sz0] = v1;
    return
      ((LowStar_Vector_vector_str__uint8_t_){ .sz = sz0 + (uint32_t)1U, .cap = cap0, .vs = vs0 });
  }
}

static LowStar_Vector_vector_str__uint8_t_
LowStar_BufVector_insert_copy__uint8_t(
  uint8_t ia,
  uint32_t blen,
  LowStar_Vector_vector_str__uint8_t_ bv,
  uint8_t *v1
)
{
  LowStar_BufVector_new_region_();
  KRML_CHECK_SIZE(sizeof(ia), blen);
  uint8_t *nv = KRML_HOST_MALLOC(sizeof(ia) * blen);
  for (uint32_t _i = 0U; _i < blen; ++_i)
    nv[_i] = ia;
  memcpy(nv, v1, blen * sizeof v1[0U]);
  return LowStar_Vector_insert__uint8_t_(bv, nv);
}

LowStar_Vector_vector_str__uint8_t_
MerkleTree_Low_insert_value(LowStar_Vector_vector_str__uint8_t_ vs, uint8_t *nv)
{
  return LowStar_BufVector_insert_copy__uint8_t((uint8_t)0U, MerkleTree_Low_hash_size, vs, nv);
}

static uint8_t
*LowStar_Vector_index__uint8_t_(LowStar_Vector_vector_str__uint8_t_ vec, uint32_t i)
{
  uint8_t **vs = vec.vs;
  return vs[i];
}

static void
LowStar_BufVector_assign_copy__uint8_t(
  uint32_t blen,
  LowStar_Vector_vector_str__uint8_t_ bv,
  uint32_t i,
  uint8_t *v1
)
{
  memcpy(LowStar_Vector_index__uint8_t_(bv, i), v1, blen * sizeof v1[0U]);
}

void
MerkleTree_Low_insert_iroots(
  LowStar_Vector_vector_str__uint8_t_ irs,
  uint32_t cpos,
  uint32_t irps,
  uint8_t *acc
)
{
  if (irps % (uint32_t)2U == (uint32_t)0U)
    LowStar_BufVector_assign_copy__uint8_t(MerkleTree_Low_hash_size, irs, cpos, acc);
  else
  {
    MerkleTree_Low_hash_from_hashes(LowStar_Vector_index__uint8_t_(irs, cpos), acc, acc);
    MerkleTree_Low_insert_iroots(irs, cpos + (uint32_t)1U, irps / (uint32_t)2U, acc);
  }
}

void MerkleTree_Low_insert(MerkleTree_Low_merkle_tree *mt, uint8_t *nv)
{
  MerkleTree_Low_merkle_tree mtv = mt[0U];
  LowStar_Vector_vector_str__uint8_t_ values = mtv.values;
  LowStar_Vector_vector_str__uint8_t_ values0 = values;
  uint32_t sz = values0.sz;
  uint32_t nvalues = sz;
  LowStar_Vector_vector_str__uint8_t_ ivalues = MerkleTree_Low_insert_value(values0, nv);
  LowStar_Vector_vector_str__uint8_t_ iroots = mtv.iroots;
  LowStar_Vector_vector_str__uint8_t_ iroots0 = iroots;
  MerkleTree_Low_insert_iroots(iroots0, (uint32_t)0U, nvalues, nv);
  mt[0U] = ((MerkleTree_Low_merkle_tree){ .values = ivalues, .iroots = iroots0 });
}

void MerkleTree_Low_compress_or_init(bool actd, uint8_t *acc, uint8_t *nh)
{
  if (actd)
    MerkleTree_Low_hash_from_hashes(nh, acc, acc);
  else
    memcpy(acc, nh, MerkleTree_Low_hash_size * sizeof nh[0U]);
}

void
MerkleTree_Low_merkle_root_of_iroots(
  LowStar_Vector_vector_str__uint8_t_ irs,
  uint32_t cpos,
  uint32_t irps,
  uint8_t *acc,
  bool actd
)
{
  if (cpos == (uint32_t)31U)
    MerkleTree_Low_compress_or_init(actd, acc, LowStar_Vector_index__uint8_t_(irs, cpos));
  else if (irps % (uint32_t)2U == (uint32_t)0U)
    MerkleTree_Low_merkle_root_of_iroots(irs, cpos + (uint32_t)1U, irps / (uint32_t)2U, acc, actd);
  else
  {
    MerkleTree_Low_compress_or_init(actd, acc, LowStar_Vector_index__uint8_t_(irs, cpos));
    MerkleTree_Low_merkle_root_of_iroots(irs, cpos + (uint32_t)1U, irps / (uint32_t)2U, acc, true);
  }
}

void MerkleTree_Low_get_root(MerkleTree_Low_merkle_tree *mt, uint8_t *rt)
{
  MerkleTree_Low_merkle_tree mtv = mt[0U];
  LowStar_Vector_vector_str__uint8_t_ values = mtv.values;
  LowStar_Vector_vector_str__uint8_t_ values0 = values;
  uint32_t sz = values0.sz;
  uint32_t nvalues = sz;
  LowStar_Vector_vector_str__uint8_t_ iroots = mtv.iroots;
  LowStar_Vector_vector_str__uint8_t_ iroots0 = iroots;
  MerkleTree_Low_merkle_root_of_iroots(iroots0, (uint32_t)0U, nvalues, rt, false);
}

static void
LowStar_BufVector_free_bufs__uint8_t(
  uint32_t blen,
  LowStar_Vector_vector_str__uint8_t_ bv,
  uint32_t idx
)
{
  KRML_HOST_FREE(LowStar_Vector_index__uint8_t_(bv, idx));
  if (idx != (uint32_t)0U)
    LowStar_BufVector_free_bufs__uint8_t(blen, bv, idx - (uint32_t)1U);
}

static void LowStar_Vector_free__uint8_t_(LowStar_Vector_vector_str__uint8_t_ vec)
{
  uint8_t **vs = vec.vs;
  KRML_HOST_FREE(vs);
}

static void
LowStar_BufVector_free__uint8_t(uint32_t blen, LowStar_Vector_vector_str__uint8_t_ bv)
{
  uint32_t sz = bv.sz;
  if (!(sz == (uint32_t)0U))
  {
    uint32_t sz = bv.sz;
    LowStar_BufVector_free_bufs__uint8_t(blen, bv, sz - (uint32_t)1U);
  }
  LowStar_Vector_free__uint8_t_(bv);
}

void MerkleTree_Low_free_merkle_tree(MerkleTree_Low_merkle_tree *mt)
{
  MerkleTree_Low_merkle_tree mtv = mt[0U];
  LowStar_Vector_vector_str__uint8_t_ values = mtv.values;
  LowStar_BufVector_free__uint8_t(MerkleTree_Low_hash_size, values);
  LowStar_Vector_vector_str__uint8_t_ iroots = mtv.iroots;
  LowStar_BufVector_free__uint8_t(MerkleTree_Low_hash_size, iroots);
  KRML_HOST_FREE(mt);
}

